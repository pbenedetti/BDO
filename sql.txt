create schema "banca_tempo";
set search_path to "banca_tempo";

--------------------------
--  CREAZIONE TABELLE   --
--------------------------

--- INDIRIZZI ---

create table indirizzi(
idIndirizzo integer primary key,
via varchar(30) not null,
nCiv varchar(5) not null,
comune varchar(30) not null,
provincia varchar(2) not null,
cap varchar(10) not null
);


--- UTENTI ---

create table utenti(
email varchar(30) primary key,
nome varchar(30) not null,
cognome varchar(30) not null,
dataN date not null,
comuneN varchar(30) not null,
sesso char check( sesso in('m','f')),
saldoH integer not null default 0,
sospensione varchar(10) check(sospensione in ('online','offline','negativo')) default 'online',
indirizzo integer not null references indirizzi on update cascade on delete no action);

 
--- TELEFONI ---

create table telefoni(
numero varchar(10) primary key
);


--- RECAPITI ---

create table recapiti(
numero varchar(10) references telefoni on update cascade on delete cascade,
email varchar(30) references utenti on update cascade on delete cascade,
primary key(numero,email)
);


--- MESSAGGI ---

create table messaggi(
riceve varchar(30) references utenti on update cascade on delete cascade,
invia varchar(30) references utenti on update cascade on delete cascade,
dataora timestamp default localtimestamp,
messaggio varchar(150) not null,
primary key (riceve, invia, dataora)
);


--- SOTTOCATEGORIE ---

create table sottocategorie(
codS integer primary key,
nomeS varchar(40) not null,
tipo varchar(30),
livello varchar(30) check (livello in ('base', 'intermedio', 'avanzato')),
specifica varchar(30),
UNIQUE (nomeS, tipo, livello, specifica)
);


--- CATEGORIE ---

create table categorie(
nomeC varchar(30) primary key
);


--- LUOGHI ---

create table luoghi(
idLuogo integer primary key,
via varchar(30) not null,
nCiv varchar(5) not null,
comune varchar(30) not null,
provincia varchar(2) not null,
cap varchar(10) not null
);


--- SPAZIO ---

create table spazio(
idSpazio integer primary key,
via varchar(30) not null,
nCiv varchar(5) not null,
comune varchar(30) not null,
provincia varchar(2) not null,
cap varchar(10) not null,
zona varchar(30) not null
);


--- AZIONI ---

create table azioni(
codAzione integer,
stato varchar(9) check(stato in('offerta','richiesta')),
attivo boolean default false,
idSpazio integer references spazio on update cascade on delete cascade,
nomeC varchar(30) references categorie on update no action on delete cascade,
primary key (codAzione, stato)
);


--- TEMPO ---

create table tempo(
idTempo integer,
codAzione integer,
stato varchar(9),
fasciaHi time not null,
fasciaHf time not null,
periodoi date not null,
periodof date not null,
giorno varchar(10) check(giorno in('lunedi','martedi','mercoledi','giovedi','venerdi','sabato','domenica')) not null,
foreign key(codAzione, stato) references azioni on delete cascade on update cascade,
primary key (idTempo, codAzione, stato),
check (fasciaHi < fasciaHf),
check (periodoi <= periodof)
);


--- PERIODI ---

create table periodi(
idPeriodo integer primary key,
data date not null,
orai time not null,
oraf time not null,
check (orai < oraf)
);


--- PRENOTAZIONI ---

create table prenotazioni(
codPre integer primary key,
riceve varchar(30) references utenti on delete cascade on update cascade,
effettua varchar(30) references utenti on delete cascade on update cascade,
idLuogo integer references luoghi on delete cascade on update cascade,
idPeriodo integer references periodi on delete cascade on update cascade,
azione varchar(10) check (azione in('accettata', 'rifiutata', 'modifica')) default 'modifica',
note varchar(150),
codAzione integer,
stato varchar(9),
foreign key(codAzione, stato) references azioni on delete cascade on update no action
);


--- PRESTAZIONI ---

create table prestazioni(
codPre integer references prenotazioni on delete cascade on update cascade,
punteggio numeric(2,0) check (punteggio between 0 and 10) not null,
feedback varchar(100),
primary key (codPre)
);


--- SPECIFICA ---

create table specifica(
email varchar(30) references utenti on delete cascade on update cascade,
stato varchar(9) ,
codAzione integer,
foreign key (codAzione, stato) references azioni on delete cascade on update cascade,
primary key(email,codAzione,stato)
);

--- SUDDIVISA ---

create table suddivisa(
codAzione integer,
stato varchar(9),
nomeC varchar(30) references categorie on delete cascade on update no action,
codS integer references sottocategorie on delete cascade on update no action,
foreign key (codAzione,stato) references azioni on delete no action on update no action,
primary key(codAzione,stato)
);


--------------------------
-- POPOLAMENTO DATABASE --
--------------------------


--- POPOLAMENTO INDIRIZZI ---

insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (1,'ticino','32','la spezia','sp','19100');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (2,'corso sardegna','62','genova','ge','16100');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (3,'avenue du pesage','132','bruxelles','be','1050');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (4,'viale italia','47','la spezia','sp','19126');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (5,'corso montegrappa','23/32','genova','ge','16100');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (6,'avenue loree','132','bruxelles','be','1050');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (7,'dell`aeroporto','32','pisa','pi','16132');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (8,'piazza giusti','54','pisa','pi','16132');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (9,'avenue louise','50','bruxelles','be','1050');
insert into indirizzi (idIndirizzo,via,nCiv,comune,provincia,cap) 
values (10,'casaregis','2','genova','ge','16100');


--- POPOLAMENTO TELEFONI ---

insert into telefoni values ('3409702553');
insert into telefoni values ('3357353951');
insert into telefoni values ('3463703684');
insert into telefoni values ('3493839754');
insert into telefoni values ('0187506562');
insert into telefoni values ('0187503760');
insert into telefoni values ('058362013');
insert into telefoni values ('3393222293');
insert into telefoni values ('0187525513');


--- POPOLAMENTO UTENTI ---

insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('ani_sar@msn.com','anastasia','sarmant','04-25-88','minsk','f',1);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('fra_mol@msn.com','francesca','torcasso','1-03-90','savona','f',1);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('rob_cre@msn.com','roberta','cresta','12-16-88','canelli','f',10);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('and_dos@msn.com','andrea','dossi','04-30-95','genova','m',3);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('mar_tor@msn.com','maria','torcia','1-08-2004','imperia','f',1);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('fra_ben@msn.com','francesca','benedetti','7-30-92','la spezia','f',4);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('and_mus@msn.com','andrea','mussi','12-03-90','rapallo','m',5);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('fed_fra@msn.com','federico','frassetto','8-18-88','genova','m',6);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('mar_sta@msn.com','marco','stanizzi','08-25-90','genova','m',6);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('din_din@msn.com','dino','rossi','1-7-87','imperia','m', 6);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('mar_pel@msn.com','mara','peluffo','7-04-48','vado','f',8);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('fra_val@msn.com','francesco','valli','4-8-99','bergamo','m',8);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('dav_viv@msn.com','davide','viviani','12-3-88','piacenza','m',9);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('luc_gel@msn.com','luca','geloso','8-08-86','albisola','m',10);
insert into utenti(email, nome,cognome,dataN,comuneN,sesso,indirizzo)
values ('cri_sar@msn.com','cristina','sarma','5-15-65','andora','f',10);


--- POPOLAMENTO RECAPITI ---

insert into recapiti(numero,email) values ('3409702553','ani_sar@msn.com');
insert into recapiti(numero,email) values ('3357353951','fra_mol@msn.com');
insert into recapiti(numero,email) values ('3463703684','fra_ben@msn.com');
insert into recapiti(numero,email) values ('3493839754','and_mus@msn.com');
insert into recapiti(numero,email) values ('3409702553','mar_sta@msn.com');
insert into recapiti(numero,email) values ('058362013','mar_pel@msn.com');
insert into recapiti(numero,email) values ('3393222293','cri_sar@msn.com');
insert into recapiti(numero,email) values ('3409702553','luc_gel@msn.com');
insert into recapiti(numero,email) values ('0187503760','dav_viv@msn.com');
insert into recapiti(numero,email) values ('3493839754','fra_val@msn.com');
insert into recapiti(numero,email) values ('3393222293','fed_fra@msn.com');
insert into recapiti(numero,email) values ('0187503760','din_din@msn.com');
insert into recapiti(numero,email) values ('3357353951','rob_cre@msn.com');
insert into recapiti(numero,email) values ('3463703684','and_dos@msn.com');
insert into recapiti(numero,email) values ('0187525513','mar_tor@msn.com');
insert into recapiti(numero,email) values ('058362013','mar_tor@msn.com');


--- POPOLAMENTO SOTTOCATEGORIE ---

insert into sottocategorie (codS, nomeS)
values (1, 'anziani');
insert into sottocategorie (codS, nomeS)
values (2, 'persone');
insert into sottocategorie (codS, nomeS)
values (3, 'visite');
insert into sottocategorie (codS, nomeS)
values (4, 'custodia e cura');
insert into sottocategorie (codS, nomeS)
values (5, 'passeggio');
insert into sottocategorie (codS, nomeS)
values (6, 'car sharing');
insert into sottocategorie (codS, nomeS)
values (7, 'lezioni');
insert into sottocategorie (codS, nomeS)
values (8, 'viaggi');
insert into sottocategorie (codS, nomeS)
values (9, 'fitness');
insert into sottocategorie (codS, nomeS)
values (10, 'baby sitter');
insert into sottocategorie (codS, nomeS)
values (11, 'scambio');
insert into sottocategorie (codS, nomeS)
values (12, 'sorveglianza');
insert into sottocategorie (codS, nomeS)
values (13, 'ginnastica');
insert into sottocategorie (codS, nomeS)
values (14, 'massaggi');
insert into sottocategorie (codS, nomeS)
values (15, 'aiuto');
insert into sottocategorie (codS, nomeS)
values (16, 'bricolage');
insert into sottocategorie (codS, nomeS)
values (17, 'lavori');
insert into sottocategorie (codS, nomeS)
values (18, 'segreteria');
insert into sottocategorie (codS, nomeS)
values (19, 'organizzazione');
insert into sottocategorie (codS, nomeS)
values (20, 'pulizie');
insert into sottocategorie (codS, nomeS)
values (21, 'stiratura');
insert into sottocategorie (codS, nomeS)
values (22, 'commissioni');
insert into sottocategorie (codS, nomeS)
values (23, 'invito');
insert into sottocategorie (codS, nomeS)
values (24, 'relazioni');
insert into sottocategorie (codS, nomeS)
values (25, 'shopping');
insert into sottocategorie (codS, nomeS)
values (26, 'donazione');
insert into sottocategorie (codS, nomeS)
values (27, 'ballo');
insert into sottocategorie (codS, nomeS)
values (28, 'cinema');
insert into sottocategorie (codS, nomeS)
values (29, 'teatro');
insert into sottocategorie (codS, nomeS)
values (30, 'escursioni');
insert into sottocategorie (codS, nomeS)
values (31, 'gite');
insert into sottocategorie (codS, nomeS)
values (32, 'passeggiate');
insert into sottocategorie (codS, nomeS)
values (33, 'arte');
insert into sottocategorie (codS, nomeS)
values (34, 'genere');
insert into sottocategorie (codS, nomeS)
values (35, 'fare');
insert into sottocategorie (codS, nomeS)
values (36, 'coppie');
insert into sottocategorie (codS, nomeS)
values (37, 'preparazione');
insert into sottocategorie (codS, nomeS)
values (38, 'riparazioni');
insert into sottocategorie (codS, nomeS)
values (39, 'società');
insert into sottocategorie (codS, nomeS)
values (40, 'più persone');
insert into sottocategorie (codS, nomeS)
values (41, 'decoupage');
insert into sottocategorie (codS, nomeS)
values (42, 'gruppi');
insert into sottocategorie (codS, nomeS)
values (43, 'letteratura');
insert into sottocategorie (codS, nomeS)
values (44, 'poesia');
insert into sottocategorie (codS, nomeS)
values (45, 'film');
insert into sottocategorie (codS, nomeS)
values (46, 'fotografia');
insert into sottocategorie (codS, nomeS)
values (47, 'bambini');
insert into sottocategorie (codS, nomeS)
values (48, 'età scolare');
insert into sottocategorie (codS, nomeS)
values (49, 'materie scolastiche');
insert into sottocategorie (codS, nomeS)
values (50, 'conversazioni');
insert into sottocategorie (codS, nomeS)
values (51, 'insegnamento');
insert into sottocategorie (codS, nomeS)
values (52, 'traduzioni');
insert into sottocategorie (codS, nomeS)
values (53, 'intrattenimanto');
insert into sottocategorie (codS, nomeS)
values (54, 'offerta');
insert into sottocategorie (codS, nomeS)
values (55, 'fornitore');
insert into sottocategorie (codS, nomeS)
values (56, 'distribuzione');
insert into sottocategorie (codS, nomeS)
values (57, 'muratura');
insert into sottocategorie (codS, nomeS)
values (58, 'legno');
insert into sottocategorie (codS, nomeS)
values (59, 'arte bianca');
insert into sottocategorie (codS, nomeS)
values (60, 'matematica');
insert into sottocategorie (codS, nomeS)
values (61, 'inglese');
insert into sottocategorie (codS, nomeS)
values (62, 'storia');
insert into sottocategorie (codS, nomeS)
values (63, 'italiano');
insert into sottocategorie (codS, nomeS)
values (64, 'geografia');
insert into sottocategorie (codS, nomeS)
values (65, 'geometria');
insert into sottocategorie (codS, nomeS)
values (66, 'acquisto');
insert into sottocategorie (codS, nomeS)
values (67, 'breve');
insert into sottocategorie (codS, nomeS)
values (68, 'a lungo termine');
insert into sottocategorie (codS, nomeS)
values (69, 'vacanze');
insert into sottocategorie (codS, nomeS)
values (70, 'fra associazioni');
insert into sottocategorie (codS, nomeS)
values (71, 'orto');
insert into sottocategorie (codS, nomeS)
values (72, 'in casa');
insert into sottocategorie (codS, nomeS)
values (73, 'amministrative');
insert into sottocategorie (codS, nomeS)
values (74, 'amatoriale');
insert into sottocategorie (codS, nomeS)
values (75,'sartoria');


--- POPOLAMENTO CATEGORIE ---

insert into categorie values ( 'sport' );
insert into categorie values ( 'pratiche' );
insert into categorie values ( 'legna' );
insert into categorie values ( 'pollice verde' );
insert into categorie values ( 'coltivazioni' );
insert into categorie values ( 'collaborazione' );
insert into categorie values ( 'ospitalita' );
insert into categorie values ( 'caret' );
insert into categorie values ( 'riuso' );
insert into categorie values ( 'musica' );
insert into categorie values ( 'lingua straniera' );
insert into categorie values ( 'lingua' );
insert into categorie values ( 'lezioni' );
insert into categorie values ( 'lettura' );
insert into categorie values ( 'hobby' );
insert into categorie values ( 'giochi' );
insert into categorie values ( 'banca del tempo' );
insert into categorie values ( 'cucito' );
insert into categorie values ( 'cucina' );
insert into categorie values ( 'consulenze' );
insert into categorie values ( 'condivisione' );
insert into categorie values ( 'computer' );
insert into categorie values ( 'compagnia' );
insert into categorie values ( 'casa' );
insert into categorie values ( 'benessere' );
insert into categorie values ( 'bambini' );
insert into categorie values ( 'automobile' );
insert into categorie values ( 'cani' );
insert into categorie values ( 'animali da cortile' );
insert into categorie values ( 'animali di casa' );
insert into categorie values ( 'accompagnamento' );

--- POPOLAMENTO LUOGHI ---

insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (1,'ticino','32','la spezia','sp','19100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (2,'italia','137','la spezia','sp','19126');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (3,'montegrappa','43/2','genova','ge','16100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (4,'sardegna','62/36','genova','ge','16100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (5,'loree','44','bruxelles','be','1050');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (6,'du pesage','132','bruxelles','be','1050');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (7,'giusti','9','pisa','pi','50605');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (8,'dell`aeroporto','12','pisa','pi','50605');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (9,'papigliano','56/22','genova','ge','16100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (10,'pieve','82','la spezia','sp','19100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (11,'cavalieri','47/1','pisa','pi','50605');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (12,'waterloo','32b','bruxelles','be','1050');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (13,'louise','89','bruxelles','be','1050');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (14,'XXsettembre','2','genova','ge','16100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (15,'nazionale','16','la spezia','sp','19100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (16,'fieschi','109','la spezia','sp','19100');
insert into luoghi (idLuogo,via,nCiv,comune,provincia,cap) values (17,'niella','12','savona','sv','17100');


--- POPOLAMENTO SPAZIO ---

insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (1,'ticino','32','la spezia','sp','19100','favaro');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (2,'italia','137','la spezia','sp','19126','migliarina');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (3,'montegrappa','43/2','genova','ge','16100','brignole');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (4,'sardegna','62/36','genova','ge','16100','marassi');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (5,'loree','44','bruxelles','be','1050','ixelles');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (6,'du pesage','132','bruxelles','be','1050','ixelles');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (7,'giusti','9','pisa','pi','50605','aeroporto');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (8,'dell`aeroporto','12','pisa','pi','50605','aeroporto');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (9,'papigliano','56/22','genova','ge','16100','s.martino');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (10,'pieve','82','la spezia','sp','19100','pieve');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (11,'cavalieri','47/1','pisa','pi','50605','centro');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (12,'waterloo','32b','bruxelles','be','1050','uccle');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (13,'louise','89','bruxelles','be','1050','ixelles');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (14,'XXsettembre','2','genova','ge','16100','centro');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (15,'nazionale','16','la spezia','sp','19100','canaletto');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (16,'fieschi','109','la spezia','sp','19100','2giugno');
insert into spazio (idSpazio,via,nCiv,comune,provincia,cap,zona) values (17,'niella','12','savona','sv','17100','centro');


--- POPOLAMENTO AZIONI ---

insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (1,'richiesta',true,1,'animali di casa');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (2,'richiesta',true,2,'automobile');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (3,'richiesta',true,10,'cani');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (4,'richiesta',true,11,'hobby');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (5,'richiesta',false,17,'lezioni');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (6,'richiesta',false,3,'animali di casa');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (7,'richiesta',false,7,'casa');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (8,'richiesta',false,8,'cucina');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (9,'offerta',true,8,'pratiche');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (10,'offerta',true,2,'cucito');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (11,'offerta',true,16,'lezioni');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (12,'offerta',true,11,'giochi');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (13,'offerta',false,12,'hobby');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (14,'offerta',false,11,'giochi');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (15,'offerta',false,10,'consulenze');
insert into azioni (codAzione,stato,attivo,idSpazio,nomeC) values (16,'offerta',false,1,'accompagnamento');


--- POPOLAMENTO TEMPO ---

insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (1,1,'richiesta','14:00','15:00','10-09-2013','10-09-2013','martedi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (2,2,'richiesta','13:00','14:00','06-14-2013','06-15-2013','mercoledi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (3,3,'richiesta','13:00','15:00','06-16-2013','06-17-2013','lunedi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (4,4,'richiesta','14:00','16:00','11-08-2013','11-08-2013','lunedi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (5,5,'richiesta','8:00','10:00','09-12-2013','09-14-2013','giovedi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (6,6,'richiesta','9:00','13:00','07-15-1013','07-17-2013','venerdi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (7,7,'richiesta','16:00','18:00','10-17-2013','10-17-2013','domenica');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (8,8,'richiesta','7:00','10:00','10-20-2013','10-22-2013','sabato');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (9,9,'offerta','8:00','9:00','10-20-2013','10-20-2014','venerdi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (10,10,'offerta','10:00','11:00','8-09-2014','9-10-2014','martedi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (11,11,'offerta','16:00','17:00','02-14-2014','02-16-2014','mercoledi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (12,12,'offerta','17:00','19:00','07-5-2013','08-14-2013','sabato');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno) 
values (13,13,'offerta','5:00','10:00','3-26-2014','03-26-2014','sabato');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno) 
values (14,14,'offerta','14:00','15:00','6-1-2014','7-1-2014','lunedi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno) 
values (15,15,'offerta',' 15:00','16:00','10-09-2014','10-09-2014','martedi');
insert into tempo (idTempo,codAzione,stato,fasciaHi,fasciaHf,periodoi,periodof,giorno)
values (16,16,'offerta','12:00','13:00','5-05-2014','5-05-2014','mercoledi');


--- POPOLAMENTO PERIODI ---

insert into periodi(idPeriodo,data,orai,oraf)
values(1,'3-15-2013','15:00','16:00');
insert into periodi(idPeriodo,data,orai,oraf)
values(2,'4-17-2013','10:00','12:00');
insert into periodi(idPeriodo,data,orai,oraf)
values(3,'1-5-2012','9:00','10:00');
insert into periodi(idPeriodo,data,orai,oraf)
values(4,'5-15-2013','8:30','9:30');
insert into periodi(idPeriodo,data,orai,oraf)
values(5,'3-3-2013','18:00','20:00');
insert into periodi(idPeriodo,data,orai,oraf)
values(6,'7-8-2013','20:00','21:00');
insert into periodi(idPeriodo,data,orai,oraf)
values(7,'7-8-2013','8:30','9:30');
insert into periodi(idPeriodo,data,orai,oraf)
values(8,'7-8-2013','10:00','12:00');
insert into periodi(idPeriodo,data,orai,oraf)
values(9,'6-10-2013','15:00','17:00');
insert into periodi(idPeriodo,data,orai,oraf)
values(10,'3-11-2013','15:00','17:00');


--- POPOLAMENTO PRENOTAZIONI ---


insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(1,'ani_sar@msn.com','luc_gel@msn.com',1,1,'modifica',1,'richiesta');
insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(2,'fra_mol@msn.com', 'ani_sar@msn.com',2,2,'modifica',2,'richiesta');
insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(3,'fed_fra@msn.com', 'ani_sar@msn.com',3,3,'modifica',3,'richiesta');
insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(4,'rob_cre@msn.com', 'ani_sar@msn.com',4,4,'modifica',4,'richiesta');
insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(5,'dav_viv@msn.com', 'mar_pel@msn.com',5,5,'modifica',9,'offerta');
insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(6,'din_din@msn.com', 'fra_ben@msn.com',6,6,'modifica',10,'offerta');
insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(7,'mar_tor@msn.com', 'fra_val@msn.com',7,7,'modifica',11,'offerta');
insert into prenotazioni(codPre,riceve,effettua,idLuogo,idPeriodo,azione,codAzione,stato)
values(8,'cri_sar@msn.com', 'rob_cre@msn.com',8,8,'modifica',12,'offerta');


--- POPOLAMENTO SPECIFICA ---

insert into specifica(email,stato,codAzione)
values('ani_sar@msn.com', 'richiesta', 1);
insert into specifica(email,stato,codAzione)
values('ani_sar@msn.com', 'richiesta', 2);
insert into specifica(email,stato,codAzione)
values('ani_sar@msn.com', 'richiesta', 3);
insert into specifica(email,stato,codAzione)
values('ani_sar@msn.com', 'richiesta', 4);
insert into specifica(email,stato,codAzione)
values('ani_sar@msn.com', 'richiesta', 5);
insert into specifica(email,stato,codAzione)
values('fra_mol@msn.com', 'richiesta', 6);
insert into specifica(email,stato,codAzione)
values('mar_sta@msn.com', 'richiesta', 7);
insert into specifica(email,stato,codAzione)
values('mar_pel@msn.com', 'richiesta', 8);
insert into specifica(email,stato,codAzione)
values('mar_pel@msn.com', 'offerta', 9);
insert into specifica(email,stato,codAzione)
values('din_din@msn.com', 'offerta', 10);
insert into specifica(email,stato,codAzione)
values('fra_val@msn.com', 'offerta', 11);
insert into specifica(email,stato,codAzione)
values('rob_cre@msn.com', 'offerta', 12);
insert into specifica(email,stato,codAzione)
values('fra_mol@msn.com', 'offerta', 13);
insert into specifica(email,stato,codAzione)
values('fra_mol@msn.com', 'offerta', 14);
insert into specifica(email,stato,codAzione)
values('fra_mol@msn.com', 'offerta', 15);
insert into specifica(email,stato,codAzione)
values('fra_mol@msn.com', 'offerta', 16);


--- POPOLAMENTO SUDDIVISA ---

insert into suddivisa(codAzione, stato, nomeC, codS)
values (1, 'richiesta','animali di casa', 4);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (2,'richiesta','automobile',6);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (3,'richiesta','cani',5);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (4,'richiesta','hobby',45);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (5,'richiesta','lezioni',63);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (6,'richiesta','animali di casa',4);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (7,'richiesta','casa',15);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (8,'richiesta','cucina',37);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (9,'offerta','pratiche',73);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (10,'offerta','cucito',17);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (11,'offerta','lezioni',65);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (12,'offerta','giochi',36);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (13,'offerta','hobby',44);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (14,'offerta','giochi',39);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (15,'offerta','consulenze',34);
insert into suddivisa(codAzione, stato, nomeC, codS)
values (16,'offerta','accompagnamento',1);




----------------------------------------
---              VISTE               ---
----------------------------------------

--informazioni relative ad indirizzi associate alle email degli utenti 

create view info_indirizzi (utente,via,n_civ,comune,prov,cap)
as
	select email,via,nCiv,comune,provincia,cap 
	from utenti,indirizzi 
	where utenti.indirizzo=indirizzi.idIndirizzo;




--informazioni anagrafiche utenti


create view anagrafica_utenti (email,nome,cognome,dataN,comuneN,sesso)
as
	select email,nome,cognome,dataN,comuneN,sesso 
	from utenti;




--informazioni angrafiche sugli utenti e loro residenza

create view info_utenti (email,nome,cognome,dataN,comuneN,sesso,via,n_civ,comune,prov,cap)
as
	select email,nome,cognome,dataN,comuneN,sesso,via,n_civ,comune,prov,cap
	from anagrafica_utenti,info_indirizzi
	where info_indirizzi.utente=anagrafica_utenti.email;



--azioni attive(danno luogo a prenotazioni)

CREATE VIEW info_accept_action ( n_prenotazione,stato,utente,azione,categoria,sottocategoria,tipo,livello,specifica)
AS 
	SELECT codpre,stato,email,azione,nomeC,nomeS,tipo,livello,specifica
	FROM prenotazioni NATURAL JOIN azioni NATURAL JOIN suddivisa NATURAL JOIN sottocategorie NATURAL JOIN specifica
	WHERE attivo = true;



--tutte le azioni offerte e richieste

CREATE VIEW info_action (prenotata,utente,stato,categoria,sottocategoria,dalle,alle,dal,al,il,via,nCiv,zona,comune,provincia,cap) AS 
 SELECT attivo,email, stato,nomec,nomes,fasciahi,fasciahf,periodoi,periodof,giorno,via,nciv,zona,comune,provincia,cap
   FROM azioni NATURAL JOIN tempo NATURAL JOIN spazio NATURAL JOIN suddivisa NATURAL JOIN sottocategorie NATURAL JOIN specifica;



--informazioni utenti coinvolti in prenotazioni

CREATE VIEW info_daa_prenotazioni (codpre,from_,to_) AS 
 SELECT codpre,riceve,effettua
   FROM prenotazioni;



--informazioni spazio/tempo prenotazioni

CREATE VIEW info_illi_prenotazioni (codpre, il,dalle,alle,via,nciv,comune,provincia,cap )
AS 
 SELECT codpre,data, orai,oraf ,via,nciv,comune,provincia,cap
   FROM prenotazioni NATURAL JOIN periodi NATURAL JOIN luoghi;


--vista prenotazioni

CREATE VIEW info_prenotazioni (codpre,stato,utente,azione,il,dalle,alle,via,numero,comune,provincia,cap,categoria,sottocategoria,tipo,livello,specifica) AS 
 SELECT codpre,stato,utente,azione,il,dalle,alle,via,nciv,comune,provincia,cap,categoria,sottocategoria,tipo,livello,specifica
   FROM info_illi_prenotazioni JOIN info_accept_action ON info_illi_prenotazioni.codpre = info_accept_action.n_prenotazione;


--info prestazioni

create view stat_prestazioni 
as
	select * from prestazioni;


--vista prestazioni
   
CREATE VIEW info_prestazioni (codice,stato,offe_rich,azione,voto,il,dalle,alle,via,numero,comune,provincia,cap,categoria,sottocategoria,tipo,livello,specifica,feedback) AS 
 SELECT codpre, stato,utente,azione,punteggio,il,dalle,alle,via,numero,comune,provincia,cap,categoria,sottocategoria,tipo,livello,specifica,feedback
   FROM info_prenotazioni natural join stat_prestazioni
  WHERE azione= 'accettata';


----------------------------------------
---              QUERY               ---
----------------------------------------


--"3)il volume di prestazioni effettive effettuate in corrispondenza di una certa offerta/richiesta"
create view query3
as
	select categoria,sottocategoria,count(*) 
	from info_prestazioni
	group by categoria,sottocategoria;


--"1)numero, saldo ore complessivo e valutazione media delle prestazioni;"
create view durata_prestaz 
as
	select sum(alle-dalle) as durata from info_prestazioni;

create view query1
as
	select count(*), durata ,avg(voto) 
	from info_prestazioni,durata_prestaz
	group by durata;


--"2)la percentuale di prenotazioni che si traducono in prestazioni;"

create view query2
as
	select 100.0* count(azione='accettata') / count(codPre) as perc_prenotazioni
	from info_prenotazioni; 


	
----------------------------------------
---             TRIGGER              ---
----------------------------------------


--controllo saldoH<-5 parametro sospensione settato a 'negativo'


CREATE OR REPLACE FUNCTION "banca_tempo".cnt_saldo()
  RETURNS trigger AS
$cnt_saldo$
    BEGIN
        if (new.saldoH < -5)
		then 
		update "banca_tempo".utenti 
		set sospensione='negativo'
		where email=new.email;
		end if;
		return new;
    END;
$cnt_saldo$ LANGUAGE plpgsql;


  create trigger cnt_saldo after update of saldoH on utenti
  for each row execute procedure cnt_saldo();



--se modifica prenotazione.azione='rifiutata' 
--delete prenotazione e setazioni.attivo='false'


create or replace function "banca_tempo".pren_del()
returns trigger as $pren_del$
begin
	if(new.azione='rifiutata')
		then
		delete from "banca_tempo".prenotazioni
		where codPre=new.codPre;

		update "banca_tempo".azioni 
		set attivo='false'
		where codAzione=new.codAzione;
		
		end if;
		return new;
	end;
$pren_del$ language plpgsql;

create trigger pren_del after update of azione on prenotazioni
for each row execute procedure pren_del();


--crea le prestazioni quando prenotazione.azione='accettata'


create or replace function "banca_tempo".crea_prestazione()
returns trigger as $crea_prestazione$  
begin

	if(new.azione='accettata' and not exists (select * from "banca_tempo".prestazioni where codPre=new.codPre) )
		then
		insert into "banca_tempo".prestazioni values (new.codPre, 0 );
		end if;
		return new;
	end;
$crea_prestazione$ language plpgsql;	


create trigger crea_prestazione after update of azione on "banca_tempo".prenotazioni
for each row execute procedure "banca_tempo".crea_prestazione();


--incremento/decremento saldo ore
--non importano giorni perche base di dati nostra prevede 
--che siano azioni da specificare all`interno di una giornata


cREATE OR REPLACE FUNCTION "banca_tempo".incdec_saldo()
  RETURNS trigger AS
$incdec_saldo$

declare user1 varchar(30); --email user che ha dichiarato azione
declare state varchar(10); --stato dell`azione dichiarata dall`user
declare user2 varchar(30); --email user coinvolto nella prenotazione
declare durata interval;   --tempo ore decremento/incremento

BEGIN

durata := (select ( alle - dalle) from  "banca_tempo".info_prestazioni where codice=new.codPre);
select offe_rich into user1 from "banca_tempo".info_prestazioni where codice=new.codPre;
select stato into state from "banca_tempo".info_prestazioni where codice=new.codPre;

    if( user1=(select from_ from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre ) and state='richiesta')
	then 
	update "banca_tempo".utenti
	set saldoH=saldoH- date_part('hour',durata)
	where email=user1;

	select to_ into user2 from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre;
	update "banca_tempo".utenti
	set saldoH=saldoH+date_part('hour',durata)
	where email=user2;

	elsif( user1=(select to_ from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre ) and state='richiesta')
	then
	update "banca_tempo".utenti
	set saldoH=saldoH - date_part('hour',durata)
	where email=user1;

	select from_ into user2 from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre;
	update "banca_tempo".utenti
	set saldoH=saldoH + date_part('hour',durata)
	where email=user2;

	elsif( user1=(select from_ from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre ) and state='offerta')
	then 
	update "banca_tempo".utenti
	set saldoH=saldoH + date_part('hour',durata)
	where email=user1;

	select to_ into user2 from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre;
	update "banca_tempo".utenti
	set saldoH=saldoH - date_part('hour',durata)
	where email=user2;

	elsif( user1=(select to_ from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre ) and state='offerta')
	then
	update "banca_tempo".utenti
	set saldoH=saldoH + date_part('hour',durata)
	where email=user1;

	select from_ into user2 from "banca_tempo".info_daa_prenotazioni where codpre=new.codPre;
	update "banca_tempo".utenti
	set saldoH=saldoH - date_part('hour',durata)
	where email=user2;


	end if;
	return new;
end;
$incdec_saldo$ LANGUAGE plpgsql;

create trigger incdec_saldo after insert on "banca_tempo".prestazioni
for each row execute procedure "banca_tempo".incdec_saldo();


--se utente.sospendione='offline' non possono esserci azioni.attivo=true
--se esistono prenotazioni attive non ancora accettate
-- per quell`utente,queste prenotazioni vengono eliminate


create or replace function "banca_tempo".cnt_offline()
returns trigger as $cnt_offline$
declare user1 varchar(30);
declare i integer ;
begin

user1 := new.email;


	if( new.sospensione='offline' and exists(select * from "banca_tempo".info_accept_action where utente=user1))
	then 
	RAISE NOTICE 'il cliente e` offline non puo ricevere/offrire prenotazioni';

--rimette a falso il campo attivo della relativa azione
--cancella la prenotazione correlata

		FOR i IN select count(*) from "banca_tempo".info_prenotazioni where utente=user1 and azione='modifica' group by codpre LOOP

			update "banca_tempo".prenotazioni
			set azione='rifiutata'
			where codPre=any(select n_prenotazione from "banca_tempo".info_accept_action where utente=user1 and azione='modifica');

		END LOOP;
	end if;
	return new;
	
end;
$cnt_offline$ language plpgsql;	
	

create trigger cnt_offline after update of sospensione on utenti
for each row execute procedure cnt_offline();


-----------------------------------
--se utente.sospensione='negativo' e ha richieste attive
--elimino tali prestazioni



create or replace function "banca_tempo".cnt_nega()
returns trigger as $cnt_nega$
declare user1 varchar(30);
declare i integer ;
begin

user1 := new.email;


	if( new.sospensione='negativo' and exists(select * from "banca_tempo".info_accept_action where utente=user1 and stato='richiesta'))
	then 
	RAISE NOTICE 'il cliente ha saldo negativo ricevere prestazioni';

--rimette a falso il campo attivo della relativa azione
--cancella la prenotazione correlata

		FOR i IN select count(*) from "banca_tempo".info_prenotazioni where utente=user1 and azione='modifica' group by codpre LOOP
		    -- i will take on the values 1,2,3,4,5,6,7,8,9,10 within the loop

			update "banca_tempo".prenotazioni
			set azione='rifiutata'
			where codPre=any(select n_prenotazione from "banca_tempo".info_accept_action where utente=user1 and azione='modifica');
		END LOOP;
	end if;
	return new;
	
end;
$cnt_nega$ language plpgsql;	
	

create trigger cnt_nega after update of sospensione on utenti
for each row execute procedure cnt_nega();



